<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="fontawesome/css/all.css" />

    <style>
    *{
        box-sizing: border-box;
    }
    .form-box{
        width:800px;
        height:650px;
        position:relative;
        margin:2% auto;
        background:rgba(195, 223, 255, 0.37);
        padding:10px;
    }
    .input-field{
        width: 50%;
        padding:10px 0;
        margin:5px 0;
        border-left:0;
        border-top:0;
        border-right:0;
        border-bottom: 1px solid #999;
        outline:none;
        background: transparent;
    }
    .form-row{
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .form-title{
        margin-right: 15px;
    }

    .input-group-edit{
        position:absolute;
        top: 100px;
        width: 450px;
        left: 0;
    }
    .edit-form{
        text-align: center;
        margin: auto;
        margin-bottom: 50px;
    }
    .ed-btn{
        width: 280px;
        padding: 10px 30px;
        cursor: pointer;
        display: block;
        margin: auto;
        background: hsl(24, 100%, 86%);
        border: 0;
        outline: none;
        border-radius: 30px;
        position:absolute;
        bottom: -100px;
        left: 265px;
    }
    .avatarZone{
        width: 300px;
        height: 300px;
        border: 1.5px solid #999;
        position:absolute;
        top: 115px;
        right: 8%;
    }
    #uploadBtn{
        position:absolute;
        top: 40%;
        right: 21.5%;
        border: 0;
    }
    #myImg{
        width: 300px;
        height: 300px;
        opacity:0;
    }

    </style>
</head>
<body>
    <div id='edit-form'class='edit-page'>
        <div class="form-box">
            <form id='edit' class='input-group-edit' name="form1" onsubmit="sendData(),renderPic() ;return false;" novalidate>
                <!-- <input type="hidden" name="member_sid" value=""> -->
                <div class="form-row">
                    <div class="form-title">姓名：</div>
                    <input type='text'class='input-field' id="member_name" name="member_name"  required>
                    <!-- <div class="form-text"></div> -->
                </div>
                <div class="form-row">
                    <div class="form-title">暱稱：</div>
                    <input type='text'class='input-field' id="member_nickname" name="member_nickname"  required>
                    <!-- <div class="form-text"></div> -->
                </div>
                <div class="form-row">
                    <div class="form-title">帳號：</div>
                    <input type='text'class='input-field' id="member_account" name="member_account"  required>
                    <!-- <div class="form-text"></div> -->
                </div>
                <div class="form-row">
                    <div class="form-title">密碼：</div>
                    <input type='password'class='input-field' id="member_password" name="member_password" required>
                    <!-- <div class="form-text"></div> -->
                </div>
                <div class="form-row">
                    <div class="form-title">生日：</div>
                    <input type="date" class= 'input-field' id="member_birthday" name="member_birthday">      
                </div>
                <div class="form-row">
                    <div class="form-title">手機：</div>
                    <input type='text'class='input-field' id="member_mobile" name="member_mobile"  required>
                    <!-- <div class="form-text"></div> -->
                </div>
                <div class="form-row">
                    <div class="form-title">地址：</div>
                    <input type='text'class='input-field' id="member_address" name="member_address"  required>
                    <!-- <div class="form-text"></div> -->
                </div>
                <div class="form-row">
                    <div class="form-title">信箱：</div>
                    <input type='email'class='input-field' id="member_mail" name="member_mail" required>
                    <!-- <div class="form-text"></div> -->
                </div>
                <button type='submit'class='ed-btn'>確認修改</button>
            </form>
            <form name="form2" action="upload-avatar-api.php" method="post" enctype="multipart/form-data" onsubmit="return false;" style="display: none">
                <input type="file" name="avatar" accept="image/*" onchange="changeImg(event)" >
            </form>           
            <div class="avatarZone">
                <img id="myImg" src="" alt="">
            </div>
            <button id="uploadBtn" onclick="uploadAvatar()">上傳頭貼&nbsp;<i class="fa-solid fa-images"></i></button>
        </div>
    </div>
</div>

<script>
    let pic = false;

    // 編輯送出
    function sendData() {
        const fd = new FormData(document.form1);
        fetch("edit-api.php",{
        method:'POST',
        body:fd
    })    

        .then((r) => r.json())
        .then((obj) => {
        data = obj;
        // console.log(obj);

        if(obj.success || pic){
            alert("修改完成！");
            window.location.href='welcome.php';
        }else{
            alert("資料沒有修改");
        }
    });
    
};

// 讀取資料庫並印在欄位上
const renderData = async () => {
    await fetch("edit-read-api.php")
    .then(r=>r.json())
    .then((obj)=> {
        const form1 =document.form1;
    
        inputS= form1.querySelectorAll('.form-row input');
        // console.log(inputS);
        for ( let i = 0; i < inputS.length; i++ ){
            inputS[i].value = obj.postData[i+1];
        }
    }
    
    )};
    
    renderData();

// 頭貼上傳
const myImg = document.querySelector("#myImg");
const uploadBtn = document.querySelector("#uploadBtn");
const avatar = document.form2.avatar;

avatar.addEventListener("change", async function (){
    const fd = new FormData(document.form2)
    const r = await fetch("upload-avatar-api.php",{
        method:"POST",
        body:fd,
    });
    const obj = await r.json();
    console.log(obj);
    myImg.src = "./uploaded/" + obj.filename; 
    if(obj.error){
        pic = false;
        alert("頭貼沒有修改");
    }else{
        pic = true;
    }
});

function uploadAvatar(){
    avatar.click();
}

// 預覽頭貼
function changeImg(){
    const file = event.currentTarget.files[0];
    console.log(file);
    const reader = new FileReader();
    reader.onload = function(){
        console.log(reader.result);
        document.querySelector("#myImg").src = reader.result;

        if( reader.result != ""){
        myImg.style.opacity = 1;
        uploadBtn.style.top= 70 + "%";
    }

    }
    reader.readAsDataURL(file);
}


const renderPic = async () => {
    await fetch("edit-read-api.php")
    .then(r=>r.json())
    .then((obj)=> {
        myImg.src = './uploaded/'+ obj.filename ;  

        if( obj.filename != ""){
        myImg.style.opacity = 1;
        uploadBtn.style.top= 70 + "%";
    } 
    }   
    )};
    renderPic();


</script>

</body>
</html>